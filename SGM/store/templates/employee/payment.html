{% extends "./employee_layout.html" %} 
{% block title %} 
Home Page 
{% endblock %} 
{% block nav %} 
  {% include "./navbarEMP.html" %} 
{% endblock nav%}
{% block content %}
<div class="w-full flex justify-between items-center px-4 mt-8">
  <p class="text-2xl font-bold">คิดเงิน</p>
  <div>
    <span id="amount">0</span><span> ชิ้น</span>
  </div>
 <div>
  <button onclick="clearSelectedProduct()" id="test-click" class="px-8 py-2 bg-[#fdfdff] hover:bg-gray-100 border text-[#333] rounded-md">
    รีเซ็ต
  </button>
  <button onclick="processPayment()" id="test-click" class="px-8 py-2 bg-[#393d3f] hover:bg-[#222] text-[#fff] rounded-md">
    ยืนยัน
  </button>
 </div>
</div>
<div
  class="border rounded px-6 py-2 flex justify-between text-center shadow-md mt-12"
>
  <a class="w-full" href="/payment">ทั้งหมด</a>|
  <a class="w-full" href="/payment/beverage">เครื่องดื่ม</a>|
  <a class="w-full" href="/payment/snack">ขนม</a>|
  <a class="w-full" href="/payment/ice-cream">ไอศกรีม</a>|
  <a class="w-full" href="/payment/household-item">ของใช้ครัวเรือน</a>
</div>

<section class="grid grid-cols-3 mt-8 gap-x-6 gap-y-6">
  {% for product in products %}
  <div onclick="selectProduct({{ product.id }})" id="product-{{ product.id }}" class="h-[300px] rounded-md hover:cursor-pointer hover:bg-gray-50 py-8 px-16 shadow-md border flex flex-col gap-3 text-center">
    <p class="text-lg">{{ product.name }}</p>
    {% comment %} <img src="" alt=""> {% endcomment %}
    <div class="bg-gray-300 h-44"></div>
    <p>คงเหลือ <span>{{product.quantity_in_stock}}</span> ชิ้น</p>
  </div>
  {% endfor %}
</section>
{% endblock content %} 
{% block script %}
<script>
  let amount = 0;
  let selectedProducts = []
  const amount_element = document.querySelector("#amount");

  const ordered_product = JSON.parse(localStorage.getItem("ordered_product"));
  // check if employee selected product before refresh page
  if (ordered_product){
    const {storage_products, storage_amount} = ordered_product
    amount_element.textContent = storage_amount
    amount = storage_amount
    selectedProducts = storage_products
    storage_products.map(productId=>{
      product = document.querySelector(`#product-${productId}`)
      if(product){
        document.querySelector(`#product-${productId}`).classList.add("bg-gray-200")
      }
    })
  }

  function selectProduct(product_id){

    const currentSeletedProduct = document.querySelector(`#product-${product_id}`)

    if (!selectedProducts.includes(product_id)){
      selectedProducts = [...selectedProducts, product_id]
      amount_element.textContent = ++amount;
      currentSeletedProduct.classList.add("bg-gray-200")
    }
    else {
      selectedProducts = selectedProducts.filter(productId=>productId!=product_id)
    console.log(selectedProducts)
    currentSeletedProduct.classList.remove("bg-gray-200")
    if (amount <= 0){
      amount = 0
      amount_element.textContent = 0
    } else {
      amount--
      amount_element.textContent = amount
    }
    }
    console.log(selectedProducts)
    
    localStorage.setItem("ordered_product", JSON.stringify({storage_products: selectedProducts, storage_amount: amount}))
  };

  function clearSelectedProduct(){
    localStorage.removeItem("ordered_product")
    window.location.reload()
  }

  async function processPayment(){
    await fetch(`/payment`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body:JSON.stringify({"order_product": selectedProducts})
    }, 
    )
    localStorage.removeItem("ordered_product")
  }


</script>
{% endblock script %}

